# ~/.bashrc

# ==================== Envs ====================

# --- bash-warning(macOS) ---
{{- if eq .chezmoi.os "darwin" }}
export BASH_SILENCE_DEPRECATION_WARNING="1"
{{- end }}

{{- range .env }}
{{- $vars := .vars }}

# --- {{ .category }} ---
{{- range (keys $vars) }}
export {{ printf . }}="{{ index $vars . }}"
{{- end }}
{{- end }}


# ==================== Paths ====================

# --- all paths ---
export PATH="{{ .paths | join ":" }}:$PATH"


# ==================== Aliases ====================
{{- range .aliases }}
{{- $cmds := .cmds }}

# --- {{ .category }} ---
{{- range (keys $cmds) }}
alias {{ . }}='{{ index $cmds . }}'
{{- end }}
{{- end }}


{{- if eq .chezmoi.os "darwin" }}
{{- range .aliases_darwin }}
{{- $cmds := .cmds }}

# --- {{ .category }}(macOS) ---
{{- range (keys $cmds) }}
alias {{ . }}='{{ index $cmds . }}'
{{- end }}
{{- end }}
{{- end }}

{{- if lookPath "nvidia-smi" }}

# --- nvidia-smi ---
alias ns='nvidia-smi'
{{- end }}


# ==================== Optimiations ====================

# Cache directory
BASH_CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/bash"
if [[ ! -d "$BASH_CACHE_DIR" ]]; then
    mkdir -p "$BASH_CACHE_DIR"
fi

# Usage: _eval_cache <cache_name> <command> <dependency_file>
function _eval_cache() {
    local cache_name="$1"
    local cmd="$2"
    local dep="$3"
    local cache_file="$BASH_CACHE_DIR/$cache_name.bash"

    # Extract command name from the command string
    local cmd_name="${cmd%% *}"

    # Skip if command doesn't exist (handle both absolute paths and commands in PATH)
    if [[ "$cmd_name" == /* ]]; then
        [[ -x "$cmd_name" ]] || return 0
    else
        command -v "$cmd_name" &>/dev/null || return 0
    fi

    # Resolve dependency path safely (handle =command syntax)
    local dep_file=""
    if [[ -n "$dep" ]]; then
        if [[ "${dep:0:1}" == "=" ]]; then
            dep_file="$(command -v "${dep#=}" 2>/dev/null)" || dep_file=""
        else
            dep_file="$dep"
        fi
    fi

    # Check if cache exists and is newer than dependency
    if [[ ! -f "$cache_file" ]] || [[ -n "$dep_file" && -f "$dep_file" && "$dep_file" -nt "$cache_file" ]]; then
        eval "$cmd" > "$cache_file" 2>/dev/null || {
            rm -f "$cache_file"
            return 0
        }
    fi

    # Source cache if it exists
    if [[ -f "$cache_file" ]]; then
        source "$cache_file"
    fi
}

# brew
{{- if eq .chezmoi.os "darwin" }}
_eval_cache "brew" "/opt/homebrew/bin/brew shellenv" "/opt/homebrew/bin/brew"
{{- else if eq .chezmoi.os "linux" }}
_eval_cache "brew" "/home/linuxbrew/.linuxbrew/bin/brew shellenv" "/home/linuxbrew/.linuxbrew/bin/brew"
{{- end }}

# mise
_eval_cache "mise" "mise activate bash" "=mise"

{{- if stat (joinPath .chezmoi.homeDir ".cargo" "env") }}
# rust
source "$HOME/.cargo/env"
{{- end }}

# fzf
_eval_cache "fzf" "fzf --bash" "=fzf"

# uv (python)
_eval_cache "uv" "uv generate-shell-completion bash" "=uv"

# theme
_eval_cache "starship" "starship init bash" "=starship"
