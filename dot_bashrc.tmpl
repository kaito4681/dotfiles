# ~/.bashrc

# ==================== Envs ====================

# --- bash-warning(macOS) ---
{{- if eq .chezmoi.os "darwin" }}
export BASH_SILENCE_DEPRECATION_WARNING="1"
{{- end }}

{{- range .env }}
{{- $vars := .vars }}

# --- {{ .category }} ---
{{- range (keys $vars) }}
export {{ printf . }}="{{ index $vars . }}"
{{- end }}
{{- end }}


# ==================== Paths ====================

# --- all paths ---
export PATH="{{ .paths | join ":" }}:$PATH"


# ==================== Aliases ====================
{{- range .aliases }}
{{- $cmds := .cmds }}

# --- {{ .category }} ---
{{- range (keys $cmds) }}
alias {{ . }}='{{ index $cmds . }}'
{{- end }}
{{- end }}


{{- if eq .chezmoi.os "darwin" }}
{{- range .aliases_darwin }}
{{- $cmds := .cmds }}

# --- {{ .category }}(macOS) ---
{{- range (keys $cmds) }}
alias {{ . }}='{{ index $cmds . }}'
{{- end }}
{{- end }}
{{- end }}

{{- if lookPath "nvidia-smi" }}

# --- nvidia-smi ---
alias ns='nvidia-smi'
{{- end }}


# ==================== Optimiations ====================

# Cache directory
BASH_CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/bash"
if [[ ! -d "$BASH_CACHE_DIR" ]]; then
    mkdir -p "$BASH_CACHE_DIR"
fi

# Usage: _eval_cache <cache_name> <command> <dependency_file>
function _eval_cache() {
    local cache_name="$1"
    local cmd="$2"
    local dep="$3"
    local cache_file="$BASH_CACHE_DIR/$cache_name.bash"

    # Check if cache exists and is newer than dependency
    if [[ ! -f "$cache_file" ]] || [[ -n "$dep" && "$dep" -nt "$cache_file" ]]; then
        eval "$cmd" > "$cache_file"
    fi

    source "$cache_file"
}

# brew
{{- if eq .chezmoi.os "darwin" }}
_eval_cache "brew" "/opt/homebrew/bin/brew shellenv" "/opt/homebrew/bin/brew"
{{- else if eq .chezmoi.os "linux" }}
_eval_cache "brew" "/home/linuxbrew/.linuxbrew/bin/brew shellenv" "/home/linuxbrew/.linuxbrew/bin/brew"
{{- end }}

# mise
_eval_cache "mise" "mise activate bash" "mise"

# rust
source "$HOME/.cargo/env"

# fzf
_eval_cache "fzf" "fzf --bash" "fzf"

# uv (python)
_eval_cache "uv" "uv generate-shell-completion bash" "uv"

# theme
_eval_cache "starship" "starship init bash" "starship"
